<div class="container">
    <div class="profile_form_wrapper">
        <div class="row">
            <div class="col-xs-12">
                <h1 style="margin-top: 0px;">Find or Create Your Restaurant</h1>
                <hr>

                <div class="col-md-6">
                    <div class="row">
                        <div class="col-xs-9">
                            <input class="form-control" data-bind="value: search_name" />
                        </div>
                        <div class="col-xs-3">
                            <button class="btn btn-default" data-bind="click: search_for_restaurant">Search</button>
                        </div>                    
                    </div>
                    <hr>                    
                    <div class="row">
                        <div class="col-xs-12">
                            <div class="restaurant_list">
                                <ul>
                                    <!-- ko foreach: restaurants -->
                                        <li data-bind="click: function(){ $root.current_restaurant($data)}">
                                            <div class="row">
                                                <h4 class="col-xs-6" data-bind="text: name"></h4>
                                                <h4 class="col-xs-6" data-bind="text: address_line_1"></h4>
                                            </div>
                                        </li>
                                    <!-- /ko -->
                                    <!-- ko if: none_or_searching -->
                                        <li><h4 data-bind="text: none_or_searching_text"></h4></li>
                                    <!-- /ko -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-xs-12">
                            <button class="btn btn-lg btn-primary col-xs-12" data-bind="click: new_restaurant">Can't find your restaurant? Create one!</button>
                        </div>                    
                    </div>                       
                </div>

                <div class="col-md-6">
                    <!-- ko with: current_restaurant -->
                        <div data-bind="template: { name: 'restaurant_static_template', data: $parent.current_restaurant }"></div>
                    <!-- /ko -->
                </div>                
                
            </div>
        </div>      
	</div>
</div>

<%= render 'shared/restaurant_static_template' %>
<%= render 'shared/restaurant_javascript' %>
<%= render 'shared/design_javascript' %>


<script type='text/javascript'>//<![CDATA[   

    function viewModel() {
        var self = this;
        self.search_name = ko.observable("");
        self.restaurants = ko.observableArray([]);
        self.current_restaurant = ko.observable();
        self.searching = ko.observable(false);
		var latitude = 0;
		var longitude = 0;    

        self.search_for_restaurant = function() {
            self.searching(true);
            $.getJSON("/app/administration/free_search_restaurants?restaurant_name=" + self.search_name() + "&lat=" + latitude + "&lon=" + longitude, function(data) { 
                self.searching(false);   
                latitude = 0;            
                longitude = 0;
                console.log(data);        
                self.restaurants($.map(data, function(item) { console.log(item); return new Restaurant(item) }));
            }).fail( function(d, textStatus, error) {
                self.searching(false);
                console.error("getJSON failed, status: " + textStatus + ", error: "+error)
            });
        };

        self.none_or_searching = ko.computed(function(){
            if(self.searching()){
                return true;
            } 

            if(self.restaurants().length == 0){
                return true;
            }
            return false;
        });

        self.none_or_searching_text = ko.computed(function(){
            if(self.searching()){
                return "Searching around your location...";
            } 

            if(self.restaurants().length == 0){
                return "None Found.";
            }
        });        

        self.set_restaurant = function(resto) {
            self.current_restaurant(resto);
        };

        self.setRestaurant = function(){
            $.ajax({
              type: "POST",
              url: "/app/administration/set_restaurant",
              data: {
                data: ko.toJSON(self.current_restaurant),
              },
                success: function(data, textStatus, jqXHR){
                    console.log("success");
                    window.location.href = "/app";
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    console.log("error: " + errorThrown);
                },
                dataType: "json"
            });             
        }

        self.new_restaurant = function(){
            // self.current_restaurant(new Restaurant({
            //                                         name:"New Restaurant",
            //                                         lat:0.0,
            //                                         lon:0.0,
            //                                         _id:null,
            //                                         address_line_2:"",
            //                                         address_line_1:"",
            //                                         phone:"",
            //                                         city:"",
            //                                         province:""
            //                                     }));
            $.ajax({
              type: "POST",
              url: "/app/administration/create_restaurant",
              data: {
                data: ko.toJSON(self.current_restaurant),
              },
                success: function(data, textStatus, jqXHR){
                    console.log("success");
                    window.location.href = "/app";
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) { 
                    console.log("error: " + errorThrown);
                },
                dataType: "json"
            });    
        }

		var success_handler = function(position) {
			latitude = position.coords.latitude;
			longitude = position.coords.longitude;
			var accuracy = position.coords.accuracy;
			self.search_for_restaurant({lat:latitude,lon:longitude});
		}

		var error_handler = function(error) {
			if (error.code === 1) {

			}
			else if (error.code === 2) {

			}
			else if (error.code === 3) {

			}
		}		

		if ("geolocation" in navigator) {
            self.searching(true);            
			navigator.geolocation.getCurrentPosition(success_handler, error_handler, {maximumAge: 10000, enableHighAccuracy: true, timeout: 30000});
		}
		else {

		}    

    };



    var viewmodel = new viewModel();
    ko.applyBindings(viewmodel);


//]]>  
</script>

